/*! pager.js - v0.6.0 - 2012-10-20
* http://oscar.finnsson.nu/pagerjs/
* Copyright (c) 2012 Oscar Finnsson; Licensed MIT */
(function(e){var t=function(t,n,r){"use strict";var i={};i.page=null,i.now=function(){return Date.now?Date.now():(new Date).valueOf()},i.extendWithPage=function(e){var t=new i.Page;e.$__page__=t,i.page=t},i.navigationFailed=r.observable(),i.showChild=function(e){i.page.showPage(e)};var s={};s.value=r.utils.unwrapObservable,s.arrayValue=function(e){return n.map(e,function(e){return s.value(e)})};var o=function(e){var t,n={},r=/\+/g,i=/([^&=]+)=?([^&]*)/g,s=function(e){return decodeURIComponent(e.replace(r," "))};while(t=i.exec(e))n[s(t[1])]=s(t[2]);return n},u=function(e){if(!e)return{name:null,params:{}};var t=e.split("?"),n=t[0],r=t[1],i={};return r&&(i=o(r)),{name:n,params:i}};i.ChildManager=function(e,t){this.currentChildO=r.observable(null);var o=this;this.page=t,this.timeStamp=i.now(),this.hideChild=function(){o.currentChild&&o.currentChild.getId()!=="start"&&(o.currentChild.hidePage(function(){}),o.currentChild=null,o.currentChildO(null))},this.showChild=function(t){this.timeStamp=i.now();var r=this.timeStamp,a=o.currentChild;o.currentChild=null;var f=!1,l=u(t[0]),c=l.name,h=null;n.each(e(),function(e){if(!f){var t=e.getId();if(t===c||(c===""||c==null)&&t==="start")f=!0,o.currentChild=e;t==="?"&&(h=e)}});var p=!1,d=o,v=function(e){if(!f){var t=e.getId(),n=e.getValue().modal;if(n){if(t===c||(c===""||c==null)&&t==="start")f=!0,o.currentChild=e,p=!0;t==="?"&&!h&&(h=e,p=!0)}}};while(!o.currentChild&&d.page.parentPage&&!d.page.getValue().modal){var m=d.page.parentPage.children;n.each(m(),v),o.currentChild||(d=d.page.parentPage.childManager)}!o.currentChild&&h&&(o.currentChild=h),o.currentChild&&(o.currentChildO(o.currentChild),p?o.currentChild.currentParentPage(o.page):o.currentChild.currentParentPage(null));var g=function(){i.navigationFailed&&i.navigationFailed({page:o.page,route:t}),o.page.getValue().navigationFailed&&s.value(o.page.getValue().navigationFailed)(o.page,t)},y=function(){var e=s.value(o.currentChild.getValue().guard);e?e(o.currentChild,t,function(){o.timeStamp===r&&o.currentChild.showPage(t.slice(1),l,t[0])},a):o.currentChild.showPage(t.slice(1),l,t[0])};a&&a===o.currentChild?y():a?a.hidePage(function(){o.currentChild?y():g()}):o.currentChild?y():g()}};var a;i.Page=function(e,t,n,s,o){this.element=e,this.valueAccessor=t,this.allBindingsAccessor=n,this.viewModel=s,this.bindingContext=o,this.children=r.observableArray([]),this.childManager=new i.ChildManager(this.children,this),this.parentPage=null,this.currentId=null,this.ctx=null,this.currentParentPage=r.observable(null),this.isVisible=r.observable(!1),this.originalRoute=r.observable(null),this.route=null};var f=i.Page.prototype;f.val=function(e){return s.value(this.getValue()[e])},f.currentChildPage=function(){return this.childManager.currentChildO},f.showPage=function(e,t,n){var r=this,i=r.currentId,s=r.pageRoute?r.pageRoute.params:null,o=r.isVisible();r.currentId=t?t.name:null,r.isVisible(!0),r.originalRoute(n),r.route=e,r.pageRoute=t,o?(r.getId()==="?"&&i!==r.currentId&&r.show(),t&&s!==t.params&&r.setParams()):(r.setParams(),r.show()),r.childManager.showChild(e)},f.setParams=function(){if(this.pageRoute&&this.pageRoute.params){var e=this.pageRoute.params,i=this.ctx,s=this.val("params")||{};t.each(e,function(e,t){n.indexOf(s,e)!==-1&&(i[e]?i[e](t):i[e]=r.observable(t))})}},f.hidePage=function(e){this.isVisible(!1),this.hideElementWrapper(e),this.childManager.hideChild()},f.init=function(){var e=this;r.utils.domNodeDisposal.addDisposeCallback(e.element,function(){e.parentPage.children.remove(e)});var t=e.getValue();return e.parentPage=e.getParentPage(),e.parentPage.children.push(this),e.hideElement(),e.val("source")&&e.loadSource(e.val("source")),e.ctx=null,t["with"]?(e.ctx=s.value(t["with"]),e.augmentContext()):t.withOnShow?e.ctx={}:(e.ctx=e.viewModel,e.augmentContext()),e.childBindingContext=e.bindingContext.createChildContext(e.ctx),r.utils.extend(e.childBindingContext,{$page:this}),e.val("withOnShow")||r.applyBindingsToDescendants(e.childBindingContext,e.element),e.parentPage.route&&e.parentPage.route[0]===e.getId()&&setTimeout(function(){e.parentPage.showPage(e.parentPage.route)},0),{controlsDescendantBindings:!0}},f.augmentContext=function(){var e=this;e.val("params")&&t.each(this.val("params"),function(t,n){e.ctx[n]||(e.ctx[n]=r.observable())}),this.val("vars")&&t.each(this.val("vars"),function(t,n){e.ctx[t]=r.observable(n)}),this.setParams()},f.getValue=function(){return this.valueAccessor?s.value(this.valueAccessor()):{}},f.getParentPage=function(){var e=this.bindingContext;while(e){if(e.$page)return e.$page;if(e.$data&&e.$data.$__page__)return e.$data.$__page__;e=e.$parentContext}return null},f.getId=function(){return this.val("id")},f.sourceUrl=function(e){var t=this;return this.getId()==="?"?r.computed(function(){var n;return t.val("deep")?n=[t.currentId].concat(t.route).join("/"):n=t.currentId,s.value(e).replace("{1}",n)}):r.computed(function(){return s.value(e)})},f.loadSource=function(e){var n=this.getValue(),o=this,u=this.element,a=null,f=n.loader||i.loader;if(n.frame==="iframe"){var l=t("iframe",t(u));l.length===0&&(l=t("<iframe></iframe>"),t(u).append(l)),f&&(a=s.value(f)(o,l),a.load()),n.sourceLoaded&&l.one("load",function(){a&&a.unload(),n.sourceLoaded(o)}),r.applyBindingsToNode(l[0],{attr:{src:this.sourceUrl(e)}})}else f&&(a=s.value(f)(o,o.element),a.load()),r.computed(function(){var i=function(){a&&a.unload(),r.applyBindingsToDescendants(o.childBindingContext,o.element),n.sourceLoaded&&n.sourceLoaded(o),o.route&&o.childManager.showChild(o.route)};if(typeof s.value(e)=="string"){var f=s.value(this.sourceUrl(e));t(u).load(f,function(){i()})}else s.value(e)(this,function(){i()})},this)},f.show=function(t){var s=this.element,o=this;o.showElementWrapper(t),o.val("title")&&(e.document.title=o.val("title")),o.val("withOnShow")&&(!o.withOnShowLoaded||o.val("sourceCache")!==!0)&&(o.withOnShowLoaded=!0,o.val("withOnShow")(n.bind(function(e){var t=o.bindingContext.createChildContext(e);o.ctx=e,o.augmentContext(),r.utils.extend(t,{$page:this}),r.applyBindingsToDescendants(t,o.element)},this),this)),o.val("sourceOnShow")&&(!o.val("sourceCache")||!s.__pagerLoaded__||typeof o.val("sourceCache")=="number"&&s.__pagerLoaded__+o.val("sourceCache")*1e3<i.now())&&(s.__pagerLoaded__=i.now(),o.loadSource(o.val("sourceOnShow")))},f.showElementWrapper=function(e){this.val("beforeShow")&&this.val("beforeShow")(this),this.showElement(e),this.val("afterShow")&&this.val("afterShow")(this)},f.showElement=function(e){this.val("showElement")?this.val("showElement")(this,e):this.val("fx")?i.fx[this.val("fx")].showElement(this,e):i.showElement?i.showElement(this,e):t(this.element).show(e)},i.Page.prototype.hideElementWrapper=function(e){this.val("beforeHide")&&this.val("beforeHide")(this),this.hideElement(e),this.val("afterHide")&&this.val("afterHide")(this)},f.hideElement=function(e){this.val("hideElement")?this.val("hideElement")(this,e):this.val("fx")?i.fx[this.val("fx")].hideElement(this,e):i.hideElement?i.hideElement(this,e):(t(this.element).hide(),e&&e())},f.getFullRoute=function(){return r.computed(function(){var e=null;return this.currentParentPage&&this.currentParentPage()?(e=this.currentParentPage().getFullRoute()(),e.push(this.originalRoute()||this.getId()),e):this.parentPage?(e=this.parentPage.getFullRoute()(),e.push(this.originalRoute()||this.getId()),e):[]},this)},f.nullObject=new i.Page,f.nullObject.children=r.observableArray([]),f.child=function(e){return r.computed(function(){var t=n.find(this.children(),function(t){return t.getId()===e});return t||this.nullObject},this)},r.bindingHandlers.page={init:function(e,t,n,r,s){var o=new i.Page(e,t,n,r,s);return o.init()}},i.useHTML5history=!1,i.rootURI="/",i.Href=function(e,t,n,i,s){this.element=e,this.bindingContext=s,this.path=r.observable(),this.val=r.observable(t)};var l=i.Href.prototype;return l.getParentPage=f.getParentPage,l.init=function(){var e=this.getParentPage();this.path=r.computed(function(){var t=s.value(this.val()());if(typeof t=="string"){var n=0;while(t.substring(0,3)==="../")n++,t=t.slice(3);var r=e.getFullRoute()(),i=r.slice(0,r.length-n).join("/"),o=(i===""?"":i+"/")+t;return o}return t.getFullRoute?t.getFullRoute()().join("/"):""},this)},i.Href.hash="#",l.bind=function(){var e=r.computed(function(){return i.Href.hash+this.path()},this);r.applyBindingsToNode(this.element,{attr:{href:e}})},l.update=function(e){this.val(e)},i.Href5=function(e,t,n,r,s){i.Href.apply(this,arguments)},i.Href5.prototype=new i.Href,i.Href5.history=e.history,i.Href5.prototype.bind=function(){r.applyBindingsToNode(this.element,{attr:{href:this.path},click:n.bind(function(){i.Href5.history.pushState(null,null,this.path())},this)})},r.bindingHandlers["page-hash"]={init:function(e,t,n,r,s){var o=new i.Href(e,t,n,r,s);o.init(),o.bind(),e.__ko__page=o},update:function(e,t){e.__ko__page.update(t)}},r.bindingHandlers["page-href5"]={init:function(e,t,n,r,s){var o=new i.Href5(e,t,n,r,s);o.init(),o.bind(),e.__ko__page=o},update:function(e,t){e.__ko__page.update(t)}},r.bindingHandlers["page-href"]={init:function(e,t,n,r,s){var o=i.useHTML5history?i.Href5:i.Href,u=new o(e,t,n,r,s);u.init(),u.bind(),e.__ko__page=u},update:function(e,t){e.__ko__page.update(t)}},i.fx={},i.fx.cssAsync=function(e){return{showElement:function(n,r){var i=t(n.element);i.addClass(e),i.show();var s=setInterval(function(){clearInterval(s),i.addClass(e+"-in")},10),o=setInterval(function(){clearInterval(o),r&&r()},300)},hideElement:function(n,r){var i=t(n.element);if(!n.pageHiddenOnce)n.pageHiddenOnce=!0,i.hide();else{i.removeClass(e+"-in");var s=setInterval(function(){clearInterval(s),r&&r(),i.hide()},300)}}}},i.fx.zoom=i.fx.cssAsync("pagerjs-fx-zoom"),i.fx.flip=i.fx.cssAsync("pagerjs-fx-flip"),i.fx.popout=i.fx.cssAsync("pagerjs-fx-popout-modal"),i.fx.jQuerySync=function(e,n){return{showElement:function(n,r){e.call(t(n.element),300,r)},hideElement:function(e,r){n.call(t(e.element),300,function(){t(e.element).hide()}),r&&r()}}},i.fx.slide=i.fx.jQuerySync(t.fn.slideDown,t.fn.slideUp),i.fx.fade=i.fx.jQuerySync(t.fn.fadeIn,t.fn.fadeOut),i.startHistoryJs=function(n){n&&History.pushState(null,null,n);var r=function(e){e.substring(0,i.Href.hash.length)===i.Href.hash&&(e=e.slice(i.Href.hash.length));var t=decodeURIComponent(e).split("/");i.showChild(t)};History.Adapter.bind(e,"statechange",function(){var e=t("base").attr("href"),n=History.getState().url.replace(e,"");r(n)}),History.Adapter.bind(e,"anchorchange",function(){r(location.hash)}),r(History.getState().url.replace(History.getRootUrl(),""))},i.startHashChange=function(n){n&&(location.hash=n),t(e).hashchange(function(){var e=location.hash;e.substring(0,i.Href.hash.length)===i.Href.hash&&(e=e.slice(i.Href.hash.length));var t=decodeURIComponent(e).split("/");i.showChild(t)}),t(e).hashchange()},i.start=function(n){n&&(location.hash=n);var r=function(e){e.substring(0,i.Href.hash.length)===i.Href.hash&&(e=e.slice(i.Href.hash.length));var t=decodeURIComponent(e).split("/");i.showChild(t)},s=function(){r(e.location.hash)};t(e).bind("hashchange",s),s()},i},n=typeof exports=="object"&&exports&&(typeof global=="object"&&global&&global===global.global&&(e=global),exports);typeof define=="function"&&typeof define.amd=="object"&&define.amd?define(["jquery","underscore","knockout"],function(e,n,r){return t($,n,r)}):n?typeof module=="object"&&module&&module.exports==n?(module.exports=pager).pager=pager:n.pager=pager:e.pager=t($,_,ko)})(this);